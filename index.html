<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DoseCalc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111827;
      --muted: #9ca3af;
      --border: #1f2937;
      --accent: #60a5fa;
      --text: #f9fafb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(34,197,94,0.07), transparent 30%),
                  var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    h1 {
      text-align: center;
      margin: 0;
      font-size: clamp(1.4rem, 4vw, 1.9rem);
    }
    h2 {
      text-align: center;
      margin: 4px 0 12px 0;
      font-size: clamp(0.95rem, 3vw, 1.1rem);
      font-weight: 500;
      color: #d1d5db;
    }

    .selector-bar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      gap: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .selector-label {
      font-size: 0.9rem;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .selector-label span {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .selector-row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .selector-row { grid-template-columns: 1fr; }
    }
    select,
    .secondary-button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      padding: 12px;
      font-size: 1rem;
      outline: none;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }
    select:focus,
    .secondary-button:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }
    .secondary-button {
      cursor: pointer;
      font-weight: 650;
      text-align: center;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      grid-template-areas:
        "compound"
        "calc"
        "dose";
      min-height: 0;
      flex: 1;
    }
    #calculatorCard { grid-area: calc; }
    #notesPanel { grid-area: compound; }
    #doseNotesPanel { grid-area: dose; }

    @media (orientation: landscape) and (min-width: 640px) {
      .layout {
        grid-template-columns: minmax(320px, 1.3fr) minmax(280px, 0.9fr);
        grid-template-areas: "calc notes";
        align-items: stretch;
        grid-auto-rows: 1fr;
        height: calc(100vh - 200px);
      }

      #calculatorCard,
      #notesPanel {
        height: 100%;
        min-height: 0;
      }

      #calculatorCard {
        overflow: auto;
      }

      #notesPanel {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #notesPanel .notes-body {
        flex: 1;
        overflow: auto;
      }

      #notesPanel { grid-area: notes; }
      #doseNotesPanel { display: none; }
    }

    @media (min-width: 1000px) {
      .layout {
        grid-template-columns: minmax(380px, 1.4fr) minmax(320px, 1fr);
        grid-template-areas: "calc notes";
      }
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    /* Dose buttons */
    .pill-button { border: none; border-radius: 999px; padding: 8px 12px; font-size: 0.88rem; background: #4b5563; color: var(--text); cursor: pointer; user-select: none; }
    .pill-button:hover { background: #6b7280; }
    .pill-button.active { background: var(--accent); color: #0b1220; }
    .small { font-size: 0.82rem; color: #cbd5e1; line-height: 1.35; }
    .link-button {
      width: 100%;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 650;
    }
    .link-button:hover { border-color: var(--accent); }

    /* Calculator */
    .card { background: var(--panel); border-radius: 16px; padding: 18px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
    .field { display: flex; flex-direction: column; margin-bottom: 14px; gap: 6px; }
    .field label { font-size: 0.9rem; color: #e5e7eb; }
    .field input { padding: 12px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: var(--text); outline: none; font-size: 1rem; }
    .field input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }

    .buttons-row { margin-top: 2px; display: flex; flex-wrap: wrap; gap: 8px; }

    .output { margin-top: 10px; padding: 12px; border-radius: 12px; background: #1f2937; border: 1px solid var(--border); }
    .output-title { font-size: 0.95rem; margin: 0 0 4px 0; color: #e5e7eb; }
    .output-value { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--text); word-break: break-word; }

    /* Notes panel */
    .notes h3 { margin: 0 0 8px 0; font-size: 1.05rem; }
    .notes h4 { margin: 0 0 6px 0; font-size: 0.95rem; color: #e5e7eb; }
    .notes .notes-meta { font-size: 0.9rem; color: #cbd5e1; margin-bottom: 8px; }
    .notes .notes-body {
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      color: #e5e7eb;
      line-height: 1.35;
      min-height: 160px;
    }
    .notes .notes-sections {
      display: grid;
      gap: 12px;
    }
    .notes .notes-section {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #111827;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .notes .notes-content {
      white-space: pre-wrap;
    }

    @media (orientation: landscape) and (min-width: 640px) {
      .notes .notes-sections { gap: 16px; }
      .notes .notes-section {
        padding: 0;
        border: none;
        border-radius: 0;
        background: transparent;
      }
      .notes .notes-section + .notes-section {
        border-top: 1px solid var(--border);
        padding-top: 12px;
        margin-top: 12px;
      }
    }

    .notes-panel--dose {
      display: block;
    }

    /* Non-standard warning */
    .warning-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 5;
      visibility: hidden;
      opacity: 0;
      transition: opacity 120ms ease, visibility 120ms ease;
    }

    .warning-overlay.open { visibility: visible; opacity: 1; }

    .warning-bubble {
      background: #111827;
      border: 1px solid #b91c1c;
      border-radius: 16px;
      max-width: 520px;
      width: min(520px, 100%);
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      position: relative;
      color: #fef2f2;
      text-align: center;
    }

    .warning-bubble h4 {
      margin: 0 0 8px 0;
      font-size: 1.05rem;
      color: #fecdd3;
    }

    .warning-bubble p { margin: 0 0 12px 0; line-height: 1.4; }

    .warning-actions {
      display: flex;
      justify-content: center;
    }

    .warning-close {
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .nonstandard-wrapper { position: relative; width: auto; }
    .nonstandard-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: max-content;
      min-width: 240px;
      position: absolute;
      left: 0;
      top: calc(100% + 6px);
      padding: 8px;
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      transition: max-height 200ms ease, opacity 180ms ease, transform 200ms ease;
      z-index: 4;
    }
    .nonstandard-list.open {
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }
    .nonstandard-toggle { background: #b45309; color: #0b1220; font-weight: 800; }
    .nonstandard-toggle:hover { background: #d97706; }

    .nonstandard-toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translate(-50%, 12px);
      background: rgba(17, 24, 39, 0.95);
      border: 1px solid #b45309;
      color: #fde68a;
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity 200ms ease, transform 200ms ease, visibility 200ms ease;
      z-index: 6;
      text-align: center;
      font-weight: 650;
    }
    .nonstandard-toast.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Reconstituted Vial Dose Calculator</h1>
    <h2>A free tool for converting reconstituted vial doses into precise syringe units and mL values.</h2>

    <div class="selector-bar">
      <div class="selector-label">Protocol library <span id="protocolSource">Loading from CSVâ€¦</span></div>
      <div class="selector-row">
        <select id="protocolSelect" aria-label="Select a protocol">
          <option value="">Default preset doses</option>
        </select>
        <button class="secondary-button" id="clearProtocol" type="button">Use default presets</button>
      </div>
    </div>

    <div class="layout">
      <!-- Calculator -->
      <div class="card" id="calculatorCard">
        <div class="field">
          <label for="vialContents">Vial Contents (mg)</label>
          <input id="vialContents" type="text" inputmode="decimal" autocomplete="off" />
        </div>

        <div class="field">
          <label for="reconVolume">Reconstitution Volume (mL)</label>
          <input id="reconVolume" type="text" inputmode="decimal" autocomplete="off" />
        </div>

        <div class="output">
          <p class="output-title">Dose per mL</p>
          <p class="output-value" id="dosePerMlDisplay">0.000 mg/mL</p>
        </div>

        <div class="field">
          <label for="desiredDose">Desired Dose (mg)</label>
          <input id="desiredDose" type="text" inputmode="decimal" autocomplete="off" />
          <div class="buttons-row" id="presetButtons">
            <!-- populated by JS -->
          </div>
        </div>

        <div class="output">
          <p class="output-title">Required Units / Volume</p>
          <p class="output-value" id="requiredUnitsDisplay">0 Units / 0.00 mL</p>
        </div>
      </div>

      <!-- Protocol Notes -->
      <div class="panel notes" id="notesPanel">
        <h3 id="protocolTitle">No protocol selected</h3>
        <div class="notes-meta" id="protocolSubtitle">Preset dose buttons use the default presets.</div>
        <div class="notes-body">
          <div class="notes-sections">
            <div class="notes-section notes-section--compound">
              <h4>Compound Notes</h4>
              <div class="notes-content" id="protocolItemNotes">Pick a protocol from the dropdown to load its preset dose buttons and notes.</div>
            </div>
            <div class="notes-section notes-section--dose">
              <h4>Dose Notes</h4>
              <div class="notes-content" id="protocolDoseNotes">Select a dose to view dose-specific notes.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel notes notes-panel--dose" id="doseNotesPanel" aria-hidden="true">
        <div class="notes-body">
          <div class="notes-sections" id="doseNotesSlot"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="warning-overlay" id="nonStandardWarning" role="alertdialog" aria-modal="true" aria-labelledby="warningTitle">
    <div class="warning-bubble">
      <h4 id="warningTitle">Non-Standard Protocol Selected</h4>
      <p id="warningMessage">Placeholder, 12345</p>
      <div class="warning-actions">
        <button type="button" class="warning-close" id="acknowledgeWarning">I Understand</button>
      </div>
    </div>
  </div>

  <div class="nonstandard-toast" id="nonstandardToast" role="status" aria-live="polite">
    You've selected a non-standard dose, please see the dose notes for more information
  </div>

  <script>
    const DEFAULT_PRESET_DOSES = [
      { label: "0.25 mg", dose: "0.25", standard: 1 },
      { label: "0.5 mg", dose: "0.5", standard: 1 },
      { label: "1 mg", dose: "1", standard: 1 },
      { label: "2.5 mg", dose: "2.5", standard: 1 }
    ];

    const STORAGE_KEY = "dosecalc.selectedProtocolId";

    let protocolLibrary = null;
    let protocolIndex = new Map();
    let selectedProtocolId = null;
    let selectedDoseNote = null;
    let currentNonStandardList = null;
    let currentNonStandardToggle = null;
    let nonStandardToastTimer = null;

    function showNonStandardWarning() {
      const overlay = document.getElementById("nonStandardWarning");
      if (overlay) overlay.classList.add("open");
    }

    function hideNonStandardWarning() {
      const overlay = document.getElementById("nonStandardWarning");
      if (overlay) overlay.classList.remove("open");
    }

    function parseWithFractions(raw) {
      if (typeof raw !== "string") return 0;
      const trimmed = raw.trim();
      if (!trimmed) return 0;

      const numeric = parseFloat(trimmed);
      if (isNaN(numeric)) return 0;

      const integerPart = Math.floor(numeric);

      if (trimmed.includes(".33")) return integerPart + 1 / 3;
      if (trimmed.includes(".66") || trimmed.includes(".67")) return integerPart + 2 / 3;

      return numeric;
    }

    function recalc() {
      const vialStr = document.getElementById("vialContents").value;
      const reconStr = document.getElementById("reconVolume").value;
      const desiredStr = document.getElementById("desiredDose").value;

      const vialContentMg = parseWithFractions(vialStr);
      const reconVolumeMl = parseWithFractions(reconStr);
      const desiredDoseMg = parseWithFractions(desiredStr);

      let dosePerMl = 0;
      if (reconVolumeMl > 0) dosePerMl = vialContentMg / reconVolumeMl;

      let requiredVolumeMl = 0;
      if (dosePerMl > 0 && desiredDoseMg > 0) requiredVolumeMl = desiredDoseMg / dosePerMl;

      const dosePerMlDisplay = document.getElementById("dosePerMlDisplay");
      if (dosePerMl > 0 && isFinite(dosePerMl)) dosePerMlDisplay.textContent = dosePerMl.toFixed(3) + " mg/mL";
      else dosePerMlDisplay.textContent = "0.000 mg/mL";

      const requiredUnitsDisplay = document.getElementById("requiredUnitsDisplay");
      if (requiredVolumeMl > 0 && isFinite(requiredVolumeMl)) {
        const units = Math.round(requiredVolumeMl * 100);
        const volStr = requiredVolumeMl.toFixed(2);
        requiredUnitsDisplay.textContent = units + " Units / " + volStr + " mL";
      } else {
        requiredUnitsDisplay.textContent = "0 Units / 0.00 mL";
      }
    }

    function safeText(v) { return (v === undefined || v === null) ? "" : String(v); }

    function escapeHtml(str) {
      return safeText(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function parseCsv(text) {
      const rows = [];
      let current = "";
      let row = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"') {
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (ch === ',' && !inQuotes) {
          row.push(current);
          current = "";
          continue;
        }

        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
          continue;
        }

        current += ch;
      }

      if (current.length || row.length) {
        row.push(current);
        rows.push(row);
      }

      if (!rows.length) return [];

      const headers = rows.shift().map(h => h.trim());
      return rows
        .filter(r => r.some(cell => cell && cell.trim() !== ""))
        .map(cells => {
          const obj = {};
          headers.forEach((h, idx) => {
            obj[h] = cells[idx] !== undefined ? cells[idx].trim() : "";
          });
          return obj;
        });
    }

    async function fetchCsv(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load ${path}: ${res.status}`);
      const text = await res.text();
      return parseCsv(text);
    }

    function numericValue(value, fallback = 0) {
      const n = parseFloat(value);
      return isNaN(n) ? fallback : n;
    }

    function buildLibraryFromCsv(categories, items, doses) {
      const title = categories[0]?.libraryTitle || "Protocol Library";
      const schemaVersion = numericValue(categories[0]?.schemaVersion, 1);

      const doseLookup = doses.reduce((acc, d) => {
        const list = acc.get(d.itemId) || [];
        list.push(d);
        acc.set(d.itemId, list);
        return acc;
      }, new Map());

      const sortedCategories = [...categories].sort((a, b) => numericValue(a.sortOrder) - numericValue(b.sortOrder));

      const sections = sortedCategories.map((cat) => {
        const sectionItems = items
          .filter(it => it.categoryId === cat.categoryId)
          .sort((a, b) => {
            const byStandard = numericValue(b.standard) - numericValue(a.standard);
            if (byStandard !== 0) return byStandard;
            return numericValue(a.sortOrder) - numericValue(b.sortOrder);
          })
          .map(it => {
            const doseList = (doseLookup.get(it.itemId) || [])
              .sort((a, b) => numericValue(a.sortOrder) - numericValue(b.sortOrder))
              .map(d => ({
                label: safeText(d.button || d.label || `${d.dose} mg`),
                dose: safeText(d.dose),
                note: safeText(d.doseNotes),
                standard: numericValue(d.standard, 1)
              }));

            return {
              id: safeText(it.itemId || it.itemName),
              name: safeText(it.itemName || it.itemId),
              notes: safeText(it.notes),
              doses: doseList,
              standard: numericValue(it.standard, 1)
            };
          });

        return { name: safeText(cat.categoryName || cat.categoryId), protocols: sectionItems };
      });

      return { title, schemaVersion, sections };
    }

    async function loadProtocolLibrary() {
      const sourceEl = document.getElementById("protocolSource");
      try {
        const [categories, items, doses] = await Promise.all([
          fetchCsv("./protocols/categories.csv"),
          fetchCsv("./protocols/items.csv"),
          fetchCsv("./protocols/doses.csv"),
        ]);
        const library = buildLibraryFromCsv(categories, items, doses);
        sourceEl.textContent = "Loaded from /protocols CSV files";
        return { library, source: "csv" };
      } catch (err) {
        console.error(err);
        sourceEl.textContent = "Using fallback presets (CSV load failed)";
        return { library: { schemaVersion: 1, title: "Fallback", sections: [] }, source: "fallback" };
      }
    }

    function buildIndex(lib) {
      protocolIndex = new Map();
      lib.sections.forEach(section => {
        section.protocols.forEach(proto => {
          protocolIndex.set(proto.id, proto);
        });
      });
    }

    function renderProtocolDropdown(lib) {
      const select = document.getElementById("protocolSelect");
      const previous = select.value;
      select.innerHTML = "";

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "Default preset doses";
      select.appendChild(defaultOption);

      lib.sections.forEach((section) => {
        const group = document.createElement("optgroup");
        group.label = section.name;

        section.protocols.forEach((proto) => {
          const option = document.createElement("option");
          option.value = proto.id;
          option.textContent = proto.name;
          group.appendChild(option);
        });

        select.appendChild(group);
      });

      if (selectedProtocolId && protocolIndex.has(selectedProtocolId)) {
        select.value = selectedProtocolId;
      } else if (previous && select.querySelector(`option[value="${previous}"]`)) {
        select.value = previous;
      } else {
        select.value = "";
      }
    }

    function syncProtocolActiveStyles() {
      const select = document.getElementById("protocolSelect");
      if (select) select.value = selectedProtocolId || "";
    }

    function notesToText(notes) {
      if (Array.isArray(notes)) return notes.map(safeText).filter(Boolean).join("\n\n");
      return safeText(notes);
    }

    function notesToHtml(notes) {
      const text = notesToText(notes);
      if (!text) return "";
      const escaped = escapeHtml(text);
      return escaped.replace(/\\n/g, "<br>").replace(/\n/g, "<br>");
    }

    function resolvePresetDoses() {
      const proto = selectedProtocolId ? protocolIndex.get(selectedProtocolId) : null;
      if (proto && Array.isArray(proto.doses) && proto.doses.length) return proto.doses;
      return DEFAULT_PRESET_DOSES;
    }

    function renderPresetButtons(doses) {
      const container = document.getElementById("presetButtons");
      container.innerHTML = "";
      closeNonStandardList();

      const standardButtons = [];
      const nonStandardButtons = [];

      const createDoseButton = (d, idx, kind) => {
        const label = safeText(d.label || (d.dose !== undefined ? d.dose + " mg" : ""));
        const doseStr = safeText(d.dose !== undefined ? d.dose : "");
        const doseNote = notesToText(d.note);

        const btn = document.createElement("button");
        btn.className = "pill-button";
        btn.type = "button";
        btn.textContent = label || doseStr;
        btn.dataset.doseKey = `${kind}-${idx}-${doseStr}`;

        btn.addEventListener("click", () => {
          const desiredInput = document.getElementById("desiredDose");
          desiredInput.value = doseStr;
          selectedDoseNote = doseNote;

          container.querySelectorAll(".pill-button").forEach(el => el.classList.remove("active"));
          btn.classList.add("active");

          renderNotes();
          recalc();

          if (kind === "nonstandard") {
            showNonStandardToast();
          }
        });

        return btn;
      };

      doses.forEach((d, idx) => {
        if (numericValue(d.standard, 1) === 0) {
          nonStandardButtons.push(createDoseButton(d, idx, "nonstandard"));
        } else {
          standardButtons.push(createDoseButton(d, idx, "standard"));
        }
      });

      if (nonStandardButtons.length) {
        const toggle = document.createElement("button");
        toggle.className = "pill-button nonstandard-toggle";
        toggle.type = "button";
        toggle.textContent = "Non-Standard";

        const nonStdList = document.createElement("div");
        nonStdList.className = "nonstandard-list";
        nonStandardButtons.forEach(btn => nonStdList.appendChild(btn));

        nonStdList.addEventListener("click", (event) => event.stopPropagation());

        toggle.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = !nonStdList.classList.contains("open");
          closeNonStandardList();
          if (isOpen) {
            nonStdList.classList.add("open");
            toggle.classList.add("active");
            currentNonStandardList = nonStdList;
            currentNonStandardToggle = toggle;
          }
        });

        const wrapper = document.createElement("div");
        wrapper.className = "nonstandard-wrapper";
        wrapper.appendChild(toggle);
        wrapper.appendChild(nonStdList);

        container.appendChild(wrapper);
      }

      standardButtons.forEach(btn => container.appendChild(btn));
    }

    function closeNonStandardList() {
      if (currentNonStandardList) currentNonStandardList.classList.remove("open");
      if (currentNonStandardToggle) currentNonStandardToggle.classList.remove("active");
      currentNonStandardList = null;
      currentNonStandardToggle = null;
    }

    function showNonStandardToast() {
      const toast = document.getElementById("nonstandardToast");
      if (!toast) return;
      toast.classList.add("show");

      if (nonStandardToastTimer) clearTimeout(nonStandardToastTimer);
      nonStandardToastTimer = setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }

    function syncDosePanelPlacement(isDesktop) {
      const dosePanel = document.getElementById("doseNotesPanel");
      const doseSlot = document.getElementById("doseNotesSlot");
      const notesSections = document.querySelector("#notesPanel .notes-sections");
      const doseSection = document.querySelector(".notes-section--dose");

      if (!dosePanel || !doseSlot || !notesSections || !doseSection) return;

      if (isDesktop) {
        if (doseSection.parentElement !== notesSections) notesSections.appendChild(doseSection);
        dosePanel.setAttribute("aria-hidden", "true");
      } else {
        if (doseSection.parentElement !== doseSlot) doseSlot.appendChild(doseSection);
        dosePanel.setAttribute("aria-hidden", "false");
      }
    }

    function renderNotes() {
      const titleEl = document.getElementById("protocolTitle");
      const subtitleEl = document.getElementById("protocolSubtitle");
      const itemNotesEl = document.getElementById("protocolItemNotes");
      const doseNotesEl = document.getElementById("protocolDoseNotes");

      const proto = selectedProtocolId ? protocolIndex.get(selectedProtocolId) : null;
      if (!proto) {
        titleEl.textContent = "No protocol selected";
        subtitleEl.textContent = "Preset dose buttons use the default presets.";
        itemNotesEl.innerHTML = escapeHtml("Pick a protocol from the dropdown to load its preset dose buttons and notes.");
        doseNotesEl.innerHTML = escapeHtml("Select a dose to view dose-specific notes.");
        return;
      }

      titleEl.textContent = proto.name || proto.id;
      subtitleEl.textContent = "Preset dose buttons loaded from the selected protocol.";

      const itemNotesHtml = notesToHtml(proto.notes) || escapeHtml("No notes provided for this protocol.");
      const doseNotesHtml = selectedDoseNote && notesToText(selectedDoseNote).trim()
        ? notesToHtml(selectedDoseNote)
        : escapeHtml("No dose note selected.");

      itemNotesEl.innerHTML = itemNotesHtml;
      doseNotesEl.innerHTML = doseNotesHtml;
    }

    function selectProtocol(protoId) {
      if (!protoId || !protocolIndex.has(protoId)) return;
      const proto = protocolIndex.get(protoId);
      selectedProtocolId = protoId;
      selectedDoseNote = null;
      localStorage.setItem(STORAGE_KEY, protoId);
      syncProtocolActiveStyles();
      renderNotes();
      renderPresetButtons(resolvePresetDoses());
      recalc();

      if (numericValue(proto.standard, 1) === 0) showNonStandardWarning();
      else hideNonStandardWarning();
    }

    function clearProtocolSelection() {
      selectedProtocolId = null;
      selectedDoseNote = null;
      localStorage.removeItem(STORAGE_KEY);
      syncProtocolActiveStyles();
      renderNotes();
      renderPresetButtons(resolvePresetDoses());
      recalc();
      hideNonStandardWarning();
    }

    document.addEventListener("DOMContentLoaded", async function () {
      const notesLayoutQuery = window.matchMedia("(orientation: landscape) and (min-width: 640px)");
      const handleNotesLayoutChange = () => syncDosePanelPlacement(notesLayoutQuery.matches);

      const inputs = [
        document.getElementById("vialContents"),
        document.getElementById("reconVolume"),
        document.getElementById("desiredDose"),
      ];
      inputs.forEach(function (input) { input.addEventListener("input", recalc); });

      handleNotesLayoutChange();
      if (typeof notesLayoutQuery.addEventListener === "function") {
        notesLayoutQuery.addEventListener("change", handleNotesLayoutChange);
      } else if (typeof notesLayoutQuery.addListener === "function") {
        notesLayoutQuery.addListener(handleNotesLayoutChange);
      }

      const warningAck = document.getElementById("acknowledgeWarning");
      if (warningAck) warningAck.addEventListener("click", hideNonStandardWarning);

      const loaded = await loadProtocolLibrary();
      protocolLibrary = loaded.library;
      buildIndex(protocolLibrary);
      renderProtocolDropdown(protocolLibrary);

      document.getElementById("protocolSelect").addEventListener("change", (event) => {
        const value = event.target.value;
        if (value) selectProtocol(value);
        else clearProtocolSelection();
      });

      document.getElementById("clearProtocol").addEventListener("click", clearProtocolSelection);

      document.addEventListener("click", (event) => {
        if (!currentNonStandardList) return;
        const isToggle = currentNonStandardToggle && currentNonStandardToggle.contains(event.target);
        const isList = currentNonStandardList && currentNonStandardList.contains(event.target);
        if (!isToggle && !isList) closeNonStandardList();
      });

      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored && protocolIndex.has(stored)) {
        selectProtocol(stored);
      } else {
        selectedProtocolId = null;
        selectedDoseNote = null;
        hideNonStandardWarning();
        syncProtocolActiveStyles();
        renderNotes();
        renderPresetButtons(resolvePresetDoses());
        recalc();
      }
    });
  </script>
</body>
</html>
