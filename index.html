<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DoseCalc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111827;
      --muted: #9ca3af;
      --border: #1f2937;
      --accent: #60a5fa;
      --text: #f9fafb;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(34,197,94,0.07), transparent 30%),
                  var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    h1 {
      text-align: center;
      margin: 0;
      font-size: clamp(1.4rem, 4vw, 1.9rem);
    }
    h2 {
      text-align: center;
      margin: 4px 0 12px 0;
      font-size: clamp(0.95rem, 3vw, 1.1rem);
      font-weight: 500;
      color: #d1d5db;
    }

    .selector-bar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      gap: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .selector-label {
      font-size: 0.9rem;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .selector-label span {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .selector-row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .selector-row { grid-template-columns: 1fr; }
    }
    select,
    .secondary-button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      padding: 12px;
      font-size: 1rem;
      outline: none;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }
    select:focus,
    .secondary-button:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }
    .secondary-button {
      cursor: pointer;
      font-weight: 650;
      text-align: center;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px) {
      .layout {
        grid-template-columns: 260px minmax(320px, 480px) 1fr;
        align-items: start;
      }
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    /* Sidebar */
    .sidebar { position: relative; overflow: hidden; }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .sidebar-title { font-size: 0.95rem; font-weight: 700; color: var(--text); }
    .sidebar-toggle {
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      line-height: 1;
    }
    .sidebar-toggle:hover { border-color: var(--accent); }
    @media (min-width: 981px) {
      .sidebar.collapsed { width: 56px; padding: 12px; }
      .sidebar.collapsed .sidebar-title,
      .sidebar.collapsed .sidebar-content,
      .sidebar.collapsed .sidebar-footer { display: none; }
      .sidebar.collapsed .sidebar-toggle { position: absolute; top: 10px; left: 10px; }
    }

    .proto-details {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #0f172a;
      margin-bottom: 10px;
    }
    .proto-details summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 12px;
      font-size: 0.9rem;
      font-weight: 700;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }
    .proto-details summary::-webkit-details-marker { display: none; }
    .proto-details summary .chev { opacity: 0.85; }

    .proto-list {
      padding: 8px;
      display: grid;
      gap: 8px;
    }

    .proto-item {
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: #111827;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      cursor: pointer;
      font-size: 0.9rem;
      line-height: 1.1;
    }
    .proto-item:hover { border-color: var(--accent); }
    .proto-item.active { border-color: var(--accent); background: rgba(96,165,250,0.12); }
    .proto-item .proto-name { font-weight: 700; display: block; margin-bottom: 4px; }
    .proto-item .proto-sub { font-size: 0.8rem; color: #cbd5e1; }

    .sidebar-footer {
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      display: grid;
      gap: 10px;
    }
    .small { font-size: 0.82rem; color: #cbd5e1; line-height: 1.35; }
    .link-button {
      width: 100%;
      border: 1px solid var(--border);
      background: #0f172a;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 650;
    }
    .link-button:hover { border-color: var(--accent); }

    /* Calculator */
    .card { background: var(--panel); border-radius: 16px; padding: 18px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
    .field { display: flex; flex-direction: column; margin-bottom: 14px; gap: 6px; }
    .field label { font-size: 0.9rem; color: #e5e7eb; }
    .field input { padding: 12px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: var(--text); outline: none; font-size: 1rem; }
    .field input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96,165,250,0.2); }

    .buttons-row { margin-top: 2px; display: flex; flex-wrap: wrap; gap: 8px; }
    .pill-button { border: none; border-radius: 999px; padding: 8px 12px; font-size: 0.88rem; background: #4b5563; color: var(--text); cursor: pointer; user-select: none; }
    .pill-button:hover { background: #6b7280; }

    .output { margin-top: 10px; padding: 12px; border-radius: 12px; background: #1f2937; border: 1px solid var(--border); }
    .output-title { font-size: 0.95rem; margin: 0 0 4px 0; color: #e5e7eb; }
    .output-value { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--text); word-break: break-word; }

    /* Notes panel */
    .notes h3 { margin: 0 0 8px 0; font-size: 1.05rem; }
    .notes .notes-meta { font-size: 0.9rem; color: #cbd5e1; margin-bottom: 8px; }
    .notes .notes-body {
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      color: #e5e7eb;
      line-height: 1.35;
      white-space: pre-wrap;
      min-height: 160px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Reconstituted Vial Dose Calculator</h1>
    <h2>A free tool for converting reconstituted vial doses into precise syringe units and mL values.</h2>

    <div class="selector-bar">
      <div class="selector-label">Protocol library <span id="protocolSource">Loading from CSV…</span></div>
      <div class="selector-row">
        <select id="protocolSelect" aria-label="Select a protocol">
          <option value="">Default preset doses</option>
        </select>
        <button class="secondary-button" id="clearProtocol" type="button">Use default presets</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Protocols menu -->
      <div class="panel sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Protocols</div>
          <button class="sidebar-toggle" id="sidebarToggle" type="button" aria-label="Toggle protocols sidebar">⟨⟩</button>
        </div>

        <div class="sidebar-content" id="protocolList">
          <!-- populated by JS -->
        </div>

        <div class="sidebar-footer">
          <div class="small">Tap a protocol to load its preset dose buttons. On mobile, the dropdown above mirrors these options.</div>
        </div>
      </div>

      <!-- CENTER: Calculator -->
      <div class="card" id="calculatorCard">
        <div class="field">
          <label for="vialContents">Vial Contents (mg)</label>
          <input id="vialContents" type="text" inputmode="decimal" autocomplete="off" />
        </div>

        <div class="field">
          <label for="reconVolume">Reconstitution Volume (mL)</label>
          <input id="reconVolume" type="text" inputmode="decimal" autocomplete="off" />
        </div>

        <div class="output">
          <p class="output-title">Dose per mL</p>
          <p class="output-value" id="dosePerMlDisplay">0.000 mg/mL</p>
        </div>

        <div class="field">
          <label for="desiredDose">Desired Dose (mg)</label>
          <input id="desiredDose" type="text" inputmode="decimal" autocomplete="off" />
          <div class="buttons-row" id="presetButtons">
            <!-- populated by JS -->
          </div>
        </div>

        <div class="output">
          <p class="output-title">Required Units / Volume</p>
          <p class="output-value" id="requiredUnitsDisplay">0 Units / 0.00 mL</p>
        </div>
      </div>

      <!-- RIGHT: Protocol Notes -->
      <div class="panel notes" id="notesPanel">
        <h3 id="protocolTitle">No protocol selected</h3>
        <div class="notes-meta" id="protocolSubtitle">Preset dose buttons use the default presets.</div>
        <div class="notes-body" id="protocolNotes">Pick a protocol from the dropdown or list to load its preset dose buttons and notes.</div>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_PRESET_DOSES = [
      { label: "0.25 mg", dose: "0.25" },
      { label: "0.5 mg", dose: "0.5" },
      { label: "1 mg", dose: "1" },
      { label: "2.5 mg", dose: "2.5" }
    ];

    const STORAGE_KEY = "dosecalc.selectedProtocolId";

    let protocolLibrary = null;
    let protocolIndex = new Map();
    let selectedProtocolId = null;

    function parseWithFractions(raw) {
      if (typeof raw !== "string") return 0;
      const trimmed = raw.trim();
      if (!trimmed) return 0;

      const numeric = parseFloat(trimmed);
      if (isNaN(numeric)) return 0;

      const integerPart = Math.floor(numeric);

      if (trimmed.includes(".33")) return integerPart + 1 / 3;
      if (trimmed.includes(".66") || trimmed.includes(".67")) return integerPart + 2 / 3;

      return numeric;
    }

    function recalc() {
      const vialStr = document.getElementById("vialContents").value;
      const reconStr = document.getElementById("reconVolume").value;
      const desiredStr = document.getElementById("desiredDose").value;

      const vialContentMg = parseWithFractions(vialStr);
      const reconVolumeMl = parseWithFractions(reconStr);
      const desiredDoseMg = parseWithFractions(desiredStr);

      let dosePerMl = 0;
      if (reconVolumeMl > 0) dosePerMl = vialContentMg / reconVolumeMl;

      let requiredVolumeMl = 0;
      if (dosePerMl > 0 && desiredDoseMg > 0) requiredVolumeMl = desiredDoseMg / dosePerMl;

      const dosePerMlDisplay = document.getElementById("dosePerMlDisplay");
      if (dosePerMl > 0 && isFinite(dosePerMl)) dosePerMlDisplay.textContent = dosePerMl.toFixed(3) + " mg/mL";
      else dosePerMlDisplay.textContent = "0.000 mg/mL";

      const requiredUnitsDisplay = document.getElementById("requiredUnitsDisplay");
      if (requiredVolumeMl > 0 && isFinite(requiredVolumeMl)) {
        const units = Math.round(requiredVolumeMl * 100);
        const volStr = requiredVolumeMl.toFixed(2);
        requiredUnitsDisplay.textContent = units + " Units / " + volStr + " mL";
      } else {
        requiredUnitsDisplay.textContent = "0 Units / 0.00 mL";
      }
    }

    function safeText(v) { return (v === undefined || v === null) ? "" : String(v); }

    function escapeHtml(str) {
      return safeText(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function parseCsv(text) {
      const rows = [];
      let current = "";
      let row = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"') {
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (ch === ',' && !inQuotes) {
          row.push(current);
          current = "";
          continue;
        }

        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          row.push(current);
          rows.push(row);
          row = [];
          current = "";
          continue;
        }

        current += ch;
      }

      if (current.length || row.length) {
        row.push(current);
        rows.push(row);
      }

      if (!rows.length) return [];

      const headers = rows.shift().map(h => h.trim());
      return rows
        .filter(r => r.some(cell => cell && cell.trim() !== ""))
        .map(cells => {
          const obj = {};
          headers.forEach((h, idx) => {
            obj[h] = cells[idx] !== undefined ? cells[idx].trim() : "";
          });
          return obj;
        });
    }

    async function fetchCsv(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load ${path}: ${res.status}`);
      const text = await res.text();
      return parseCsv(text);
    }

    function numericValue(value, fallback = 0) {
      const n = parseFloat(value);
      return isNaN(n) ? fallback : n;
    }

    function buildLibraryFromCsv(categories, items, doses) {
      const title = categories[0]?.libraryTitle || "Protocol Library";
      const schemaVersion = numericValue(categories[0]?.schemaVersion, 1);

      const doseLookup = doses.reduce((acc, d) => {
        const list = acc.get(d.itemId) || [];
        list.push(d);
        acc.set(d.itemId, list);
        return acc;
      }, new Map());

      const sortedCategories = [...categories].sort((a, b) => numericValue(a.sortOrder) - numericValue(b.sortOrder));

      const sections = sortedCategories.map((cat) => {
        const sectionItems = items
          .filter(it => it.categoryId === cat.categoryId)
          .sort((a, b) => {
            const byStandard = numericValue(b.standard) - numericValue(a.standard);
            if (byStandard !== 0) return byStandard;
            return numericValue(a.sortOrder) - numericValue(b.sortOrder);
          })
          .map(it => {
            const doseList = (doseLookup.get(it.itemId) || [])
              .sort((a, b) => numericValue(a.sortOrder) - numericValue(b.sortOrder))
              .map(d => ({
                label: safeText(d.button || d.label || `${d.dose} mg`),
                dose: safeText(d.dose),
                note: safeText(d.doseNotes)
              }));

            return {
              id: safeText(it.itemId || it.itemName),
              name: safeText(it.itemName || it.itemId),
              notes: safeText(it.notes),
              doses: doseList
            };
          });

        return { name: safeText(cat.categoryName || cat.categoryId), protocols: sectionItems };
      });

      return { title, schemaVersion, sections };
    }

    async function loadProtocolLibrary() {
      const sourceEl = document.getElementById("protocolSource");
      try {
        const [categories, items, doses] = await Promise.all([
          fetchCsv("./protocols/categories.csv"),
          fetchCsv("./protocols/items.csv"),
          fetchCsv("./protocols/doses.csv"),
        ]);
        const library = buildLibraryFromCsv(categories, items, doses);
        sourceEl.textContent = "Loaded from /protocols CSV files";
        return { library, source: "csv" };
      } catch (err) {
        console.error(err);
        sourceEl.textContent = "Using fallback presets (CSV load failed)";
        return { library: { schemaVersion: 1, title: "Fallback", sections: [] }, source: "fallback" };
      }
    }

    function buildIndex(lib) {
      protocolIndex = new Map();
      lib.sections.forEach(section => {
        section.protocols.forEach(proto => {
          protocolIndex.set(proto.id, proto);
        });
      });
    }

    function renderProtocolList(lib) {
      const container = document.getElementById("protocolList");
      container.innerHTML = "";

      if (!lib.sections.length) {
        container.innerHTML = '<div class="small">No protocols found.</div>';
        return;
      }

      lib.sections.forEach((section) => {
        const details = document.createElement("details");
        details.className = "proto-details";
        details.open = true;

        const summary = document.createElement("summary");
        summary.innerHTML = '<span>' + escapeHtml(section.name) + '</span><span class="chev">▾</span>';

        const list = document.createElement("div");
        list.className = "proto-list";

        section.protocols.forEach((proto) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "proto-item";
          btn.setAttribute("data-proto-id", proto.id);

          const sub = (proto.doses && proto.doses.length) ? `${proto.doses.length} preset dose button(s)` : "No preset doses";
          btn.innerHTML = '<span class="proto-name">' + escapeHtml(proto.name) + '</span>'
                        + '<span class="proto-sub">' + escapeHtml(sub) + '</span>';

          btn.addEventListener("click", () => selectProtocol(proto.id));
          list.appendChild(btn);
        });

        details.appendChild(summary);
        details.appendChild(list);
        container.appendChild(details);
      });

      syncProtocolActiveStyles();
    }

    function renderProtocolDropdown(lib) {
      const select = document.getElementById("protocolSelect");
      const previous = select.value;
      select.innerHTML = "";

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "Default preset doses";
      select.appendChild(defaultOption);

      lib.sections.forEach((section) => {
        const group = document.createElement("optgroup");
        group.label = section.name;

        section.protocols.forEach((proto) => {
          const option = document.createElement("option");
          option.value = proto.id;
          option.textContent = proto.name;
          group.appendChild(option);
        });

        select.appendChild(group);
      });

      if (selectedProtocolId && protocolIndex.has(selectedProtocolId)) {
        select.value = selectedProtocolId;
      } else if (previous && select.querySelector(`option[value="${previous}"]`)) {
        select.value = previous;
      } else {
        select.value = "";
      }
    }

    function syncProtocolActiveStyles() {
      const items = document.querySelectorAll(".proto-item[data-proto-id]");
      items.forEach(el => {
        const id = el.getAttribute("data-proto-id");
        if (id && id === selectedProtocolId) el.classList.add("active");
        else el.classList.remove("active");
      });

      const select = document.getElementById("protocolSelect");
      if (select) select.value = selectedProtocolId || "";
    }

    function notesToText(notes) {
      if (Array.isArray(notes)) return notes.map(safeText).filter(Boolean).join("\n\n");
      return safeText(notes);
    }

    function resolvePresetDoses() {
      const proto = selectedProtocolId ? protocolIndex.get(selectedProtocolId) : null;
      if (proto && Array.isArray(proto.doses) && proto.doses.length) return proto.doses;
      return DEFAULT_PRESET_DOSES;
    }

    function renderPresetButtons(doses) {
      const container = document.getElementById("presetButtons");
      container.innerHTML = "";

      doses.forEach((d) => {
        const label = safeText(d.label || (d.dose !== undefined ? d.dose + " mg" : ""));
        const doseStr = safeText(d.dose !== undefined ? d.dose : "");

        const btn = document.createElement("button");
        btn.className = "pill-button";
        btn.type = "button";
        btn.textContent = label || doseStr;

        btn.addEventListener("click", () => {
          const desiredInput = document.getElementById("desiredDose");
          desiredInput.value = doseStr;
          recalc();
        });

        container.appendChild(btn);
      });
    }

    function renderNotes() {
      const titleEl = document.getElementById("protocolTitle");
      const subtitleEl = document.getElementById("protocolSubtitle");
      const notesEl = document.getElementById("protocolNotes");

      const proto = selectedProtocolId ? protocolIndex.get(selectedProtocolId) : null;
      if (!proto) {
        titleEl.textContent = "No protocol selected";
        subtitleEl.textContent = "Preset dose buttons use the default presets.";
        notesEl.textContent = "Pick a protocol from the dropdown or list to load its preset dose buttons and notes.";
        return;
      }

      titleEl.textContent = proto.name || proto.id;
      subtitleEl.textContent = "Preset dose buttons loaded from the selected protocol.";
      const notesText = notesToText(proto.notes) || "No notes provided for this protocol.";
      notesEl.textContent = notesText;
    }

    function selectProtocol(protoId) {
      if (!protoId || !protocolIndex.has(protoId)) return;
      selectedProtocolId = protoId;
      localStorage.setItem(STORAGE_KEY, protoId);
      syncProtocolActiveStyles();
      renderNotes();
      renderPresetButtons(resolvePresetDoses());
      recalc();
    }

    function clearProtocolSelection() {
      selectedProtocolId = null;
      localStorage.removeItem(STORAGE_KEY);
      syncProtocolActiveStyles();
      renderNotes();
      renderPresetButtons(resolvePresetDoses());
      recalc();
    }

    function initSidebarToggle() {
      const sidebar = document.getElementById("sidebar");
      const toggleBtn = document.getElementById("sidebarToggle");

      toggleBtn.addEventListener("click", () => {
        if (window.matchMedia("(min-width: 981px)").matches) {
          sidebar.classList.toggle("collapsed");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", async function () {
      const inputs = [
        document.getElementById("vialContents"),
        document.getElementById("reconVolume"),
        document.getElementById("desiredDose"),
      ];
      inputs.forEach(function (input) { input.addEventListener("input", recalc); });

      initSidebarToggle();

      const loaded = await loadProtocolLibrary();
      protocolLibrary = loaded.library;
      buildIndex(protocolLibrary);
      renderProtocolList(protocolLibrary);
      renderProtocolDropdown(protocolLibrary);

      document.getElementById("protocolSelect").addEventListener("change", (event) => {
        const value = event.target.value;
        if (value) selectProtocol(value);
        else clearProtocolSelection();
      });

      document.getElementById("clearProtocol").addEventListener("click", clearProtocolSelection);

      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored && protocolIndex.has(stored)) {
        selectedProtocolId = stored;
      } else {
        selectedProtocolId = null;
      }

      syncProtocolActiveStyles();
      renderNotes();
      renderPresetButtons(resolvePresetDoses());
      recalc();
    });
  </script>
</body>
</html>
